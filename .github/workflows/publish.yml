name: Publish

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
    branches:
      - main

concurrency:
  group: publish-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  build:
    name: Build distributions
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Build sdist and wheel
        run: uv build

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  publish:
    name: Publish to PyPI
    needs: build
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    environment:
      name: pypi
      url: https://pypi.org/project/django-returns/
    steps:
      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Check if version already exists on PyPI
        shell: bash
        run: |
          set -euo pipefail
          wheel_file="$(ls -1 dist/*.whl | head -n 1)"
          wheel_base="$(basename "$wheel_file")"
          version="$(echo "$wheel_base" | cut -d- -f2)"

          echo "Detected version: $version"

          if curl -fsSL "https://pypi.org/pypi/django-returns/${version}/json" >/dev/null; then
            echo "Version ${version} already exists on PyPI; skipping publish."
            echo "SKIP_PUBLISH=true" >> "$GITHUB_ENV"
          else
            echo "Version ${version} not found on PyPI; will publish."
          fi

      - name: Publish
        if: env.SKIP_PUBLISH != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1

